<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>H·ªá Th·ªëng Gi√°m S√°t Kh√¥ng Kh√≠ - Simon House</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/paho-mqtt/1.0.1/mqttws31.min.js" type="text/javascript"></script>
    <style>
        body { font-family: 'Segoe UI', sans-serif; background-color: #f0f2f5; text-align: center; padding: 20px; }
        h1 { color: #333; }
        #status { font-size: 14px; color: #666; margin-bottom: 20px; font-weight: bold;}
        
        #alert-box {
            background-color: #95a5a6; color: white; padding: 20px;
            border-radius: 15px; font-size: 1.5em; font-weight: bold;
            margin: 20px auto; max-width: 600px;
            box-shadow: 0 4px 10px rgba(0,0,0,0.1);
        }

        .grid-container {
            display: grid; grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
            gap: 15px; max-width: 800px; margin: 0 auto;
        }

        .card { background: white; padding: 15px; border-radius: 10px; box-shadow: 0 2px 5px rgba(0,0,0,0.1); }
        .card h3 { margin: 0; font-size: 1em; color: #555; }
        .value { font-size: 1.8em; font-weight: bold; color: #2c3e50; margin: 10px 0; }
        .unit { font-size: 0.8em; color: #888; }
        
        .danger-mode { background-color: #e74c3c !important; animation: pulse 1s infinite; }
        .safe-mode { background-color: #2ecc71 !important; }
        @keyframes pulse { 0% { transform: scale(1); } 50% { transform: scale(1.05); } 100% { transform: scale(1); } }
    </script>
</head>
<body>

    <h1>üì° GI√ÅM S√ÅT KH√îNG KH√ç (HiveMQ)</h1>
    <div id="status">üü° ƒêang k·∫øt n·ªëi Server...</div>

    <div id="alert-box">ƒêANG CH·ªú D·ªÆ LI·ªÜU...</div>

    <div class="grid-container">
        <div class="card">
            <h3>Nhi·ªát ƒë·ªô</h3>
            <div class="value"><span id="temp">--</span></div>
            <div class="unit">¬∞C</div>
        </div>
        <div class="card">
            <h3>ƒê·ªô ·∫©m</h3>
            <div class="value"><span id="hum">--</span></div>
            <div class="unit">%</div>
        </div>
        <div class="card">
            <h3>AQI</h3>
            <div class="value"><span id="aqi">--</span></div>
            <div class="unit">Index</div>
        </div>
        <div class="card">
            <h3>eCO2</h3>
            <div class="value"><span id="eco2">--</span></div>
            <div class="unit">ppm</div>
        </div>
        <div class="card">
            <h3>TVOC</h3>
            <div class="value"><span id="tvoc">--</span></div>
            <div class="unit">ppb</div>
        </div>
    </div>

    <script>
        // --- 1. C·∫§U H√åNH HIVEMQ CLOUD ---
        // Link Server (Kh√¥ng c√≥ wss://, ch·ªâ l·∫•y t√™n mi·ªÅn)
        var mqtt_server = "e35ff2a8c16f4c60981704de63982340.s1.eu.hivemq.cloud"; 
        var mqtt_port = 8884; // C·ªïng Web Secure
        
        // --- ƒêI·ªÄN USERNAME / PASSWORD C·ª¶A B·∫†N V√ÄO ƒê√ÇY ---
        var mqtt_user = "Huflit"; 
        var mqtt_pass = "Huflit123456"; // M·∫≠t kh·∫©u b·∫°n ƒë√£ t·∫°o

        // T·∫°o Client ID ng·∫´u nhi√™n
        var client = new Paho.MQTT.Client(mqtt_server, mqtt_port, "Web_" + new Date().getTime());

        // C√†i ƒë·∫∑t h√†m x·ª≠ l√Ω
        client.onConnectionLost = onConnectionLost;
        client.onMessageArrived = onMessageArrived;

        // C·∫•u h√¨nh k·∫øt n·ªëi
        var options = {
            useSSL: true,         // B·∫ÆT BU·ªòC
            userName: mqtt_user,  // B·∫ÆT BU·ªòC
            password: mqtt_pass,  // B·∫ÆT BU·ªòC
            onSuccess: onConnect,
            onFailure: onFail
        };

        console.log("ƒêang k·∫øt n·ªëi ƒë·∫øn " + mqtt_server);
        client.connect(options);

        // --- C√ÅC H√ÄM X·ª¨ L√ù ---
        function onConnect() {
            console.log("‚úÖ ƒê√£ k·∫øt n·ªëi HiveMQ!");
            document.getElementById("status").innerText = "üü¢ ƒê√£ k·∫øt n·ªëi HiveMQ Cloud";
            document.getElementById("status").style.color = "green";
            
            // ƒêƒÉng k√Ω nh·∫≠n tin t·ª´ t·∫•t c·∫£ topic
            client.subscribe("simon_house/air/#");
        }

        function onFail(responseObject) {
            console.log("‚ùå L·ªói k·∫øt n·ªëi: " + responseObject.errorMessage);
            document.getElementById("status").innerText = "üî¥ L·ªói k·∫øt n·ªëi: " + responseObject.errorMessage;
            document.getElementById("status").style.color = "red";
        }

        function onConnectionLost(responseObject) {
            if (responseObject.errorCode !== 0) {
                console.log("M·∫•t k·∫øt n·ªëi: " + responseObject.errorMessage);
                document.getElementById("status").innerText = "üü° M·∫•t k·∫øt n·ªëi...";
                document.getElementById("status").style.color = "orange";
            }
        }

        function onMessageArrived(message) {
            var topic = message.destinationName;
            var msg = message.payloadString;
            console.log("Nh·∫≠n [" + topic + "]: " + msg);

            // C·∫≠p nh·∫≠t giao di·ªán
            if (topic.includes("temp")) document.getElementById("temp").innerText = msg;
            else if (topic.includes("hum")) document.getElementById("hum").innerText = msg;
            else if (topic.includes("aqi")) {
                document.getElementById("aqi").innerText = msg;
                // ƒê·ªïi m√†u AQI n·∫øu cao
                var val = parseInt(msg);
                document.getElementById("aqi").style.color = (val >= 3) ? "red" : "#2c3e50";
            }
            else if (topic.includes("eco2")) document.getElementById("eco2").innerText = msg;
            else if (topic.includes("tvoc")) document.getElementById("tvoc").innerText = msg;
            else if (topic.includes("alert")) handleAlert(msg);
        }

        function handleAlert(msg) {
            var box = document.getElementById("alert-box");
            box.innerText = msg;
            
            if (msg.includes("CANH BAO") || msg.includes("O NHIEM")) {
                box.className = "danger-mode";
            } else if (msg.includes("An toan") || msg.includes("khoi dong")) {
                box.className = "safe-mode";
            } else {
                box.className = "";
                box.style.backgroundColor = "#95a5a6";
            }
        }
    </script>
</body>
</html>
