<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>H·ªá Th·ªëng Gi√°m S√°t Kh√¥ng Kh√≠ - Simon House</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/paho-mqtt/1.0.1/mqttws31.min.js" type="text/javascript"></script>
    <style>
        body { font-family: 'Segoe UI', sans-serif; background-color: #f0f2f5; text-align: center; padding: 20px; }
        h1 { color: #333; margin-bottom: 5px; }
        
        /* Tr·∫°ng th√°i k·∫øt n·ªëi */
        #status { font-size: 14px; font-weight: bold; color: orange; margin-bottom: 20px; }

        /* H·ªôp c·∫£nh b√°o l·ªõn */
        #alert-box {
            background-color: #95a5a6; color: white; padding: 20px;
            border-radius: 15px; font-size: 1.5em; font-weight: bold;
            margin: 0 auto 30px auto; max-width: 600px;
            box-shadow: 0 4px 10px rgba(0,0,0,0.1);
            transition: background-color 0.3s;
        }

        /* L∆∞·ªõi hi·ªÉn th·ªã 5 th√¥ng s·ªë */
        .grid-container {
            display: grid; 
            grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
            gap: 15px; max-width: 800px; margin: 0 auto;
        }

        .card { background: white; padding: 20px; border-radius: 10px; box-shadow: 0 2px 5px rgba(0,0,0,0.1); }
        .card h3 { margin: 0; font-size: 1em; color: #7f8c8d; }
        .value { font-size: 2em; font-weight: bold; color: #2c3e50; margin: 10px 0; }
        .unit { font-size: 0.9em; color: #bdc3c7; }
        
        /* Hi·ªáu ·ª©ng c·∫£nh b√°o */
        .danger-mode { background-color: #e74c3c !important; animation: pulse 1s infinite; }
        .safe-mode { background-color: #2ecc71 !important; }
        @keyframes pulse { 0% { transform: scale(1); } 50% { transform: scale(1.05); } 100% { transform: scale(1); } }
    </style>
</head>
<body>

    <h1>üì° GI√ÅM S√ÅT KH√îNG KH√ç</h1>
    <div id="status">üü° ƒêang k·∫øt n·ªëi HiveMQ Cloud...</div>

    <div id="alert-box">ƒêANG CH·ªú D·ªÆ LI·ªÜU...</div>

    <div class="grid-container">
        <div class="card">
            <h3>Nhi·ªát ƒë·ªô</h3>
            <div class="value"><span id="temp">--</span></div>
            <div class="unit">¬∞C</div>
        </div>
        <div class="card">
            <h3>ƒê·ªô ·∫©m</h3>
            <div class="value"><span id="hum">--</span></div>
            <div class="unit">%</div>
        </div>
        <div class="card">
            <h3>AQI</h3>
            <div class="value"><span id="aqi">--</span></div>
            <div class="unit">Index</div>
        </div>
        <div class="card">
            <h3>eCO2</h3>
            <div class="value"><span id="eco2">--</span></div>
            <div class="unit">ppm</div>
        </div>
        <div class="card">
            <h3>TVOC</h3>
            <div class="value"><span id="tvoc">--</span></div>
            <div class="unit">ppb</div>
        </div>
    </div>

    <script>
        // --- 1. C·∫§U H√åNH HIVEMQ CLOUD ---
        var mqtt_server = "e35ff2a8c16f4c60981704de63982340.s1.eu.hivemq.cloud"; 
        var mqtt_port = 8884; // C·ªïng Web Secure (WSS)
        
        var mqtt_user = "Huflit"; 
        var mqtt_pass = "Huflit123456"; // M·∫≠t kh·∫©u c·ªßa b·∫°n

        // T·∫°o ID ng·∫´u nhi√™n cho Client
        var client = new Paho.MQTT.Client(mqtt_server, mqtt_port, "Web_" + new Date().getTime());

        // C√†i ƒë·∫∑t h√†m x·ª≠ l√Ω s·ª± ki·ªán
        client.onConnectionLost = onConnectionLost;
        client.onMessageArrived = onMessageArrived;

        // C·∫•u h√¨nh k·∫øt n·ªëi
        var options = {
            useSSL: true,         // B·∫Øt bu·ªôc
            userName: mqtt_user,  // B·∫Øt bu·ªôc
            password: mqtt_pass,  // B·∫Øt bu·ªôc
            onSuccess: onConnect,
            onFailure: onFail
        };

        console.log("ƒêang k·∫øt n·ªëi ƒë·∫øn HiveMQ...");
        client.connect(options);

        // --- C√ÅC H√ÄM X·ª¨ L√ù ---
        function onConnect() {
            console.log("‚úÖ K·∫æT N·ªêI TH√ÄNH C√îNG!");
            document.getElementById("status").innerText = "üü¢ ƒê√£ k·∫øt n·ªëi HiveMQ Cloud";
            document.getElementById("status").style.color = "green";
            
            // ƒêƒÉng k√Ω nh·∫≠n tin t·ª´ t·∫•t c·∫£ topic
            client.subscribe("simon_house/air/#");
        }

        function onFail(responseObject) {
            console.log("‚ùå L·ªói k·∫øt n·ªëi: " + responseObject.errorMessage);
            document.getElementById("status").innerText = "üî¥ L·ªói k·∫øt n·ªëi: " + responseObject.errorMessage;
            document.getElementById("status").style.color = "red";
        }

        function onConnectionLost(responseObject) {
            if (responseObject.errorCode !== 0) {
                console.log("M·∫•t k·∫øt n·ªëi: " + responseObject.errorMessage);
                document.getElementById("status").innerText = "üü° M·∫•t k·∫øt n·ªëi...";
                document.getElementById("status").style.color = "orange";
            }
        }

        function onMessageArrived(message) {
            var topic = message.destinationName;
            var msg = message.payloadString;
            console.log("Nh·∫≠n [" + topic + "]: " + msg);

            // C·∫≠p nh·∫≠t l√™n giao di·ªán
            if (topic.includes("temp")) document.getElementById("temp").innerText = msg;
            else if (topic.includes("hum")) document.getElementById("hum").innerText = msg;
            else if (topic.includes("aqi")) {
                document.getElementById("aqi").innerText = msg;
                // ƒê·ªïi m√†u s·ªë AQI n·∫øu cao
                var val = parseInt(msg);
                document.getElementById("aqi").style.color = (val >= 3) ? "red" : "#2c3e50";
            }
            else if (topic.includes("eco2")) document.getElementById("eco2").innerText = msg;
            else if (topic.includes("tvoc")) document.getElementById("tvoc").innerText = msg;
            else if (topic.includes("alert")) handleAlert(msg);
        }

        function handleAlert(msg) {
            var box = document.getElementById("alert-box");
            box.innerText = msg;
            
            // Logic ƒë·ªïi m√†u n·ªÅn c·∫£nh b√°o
            if (msg.includes("CANH BAO") || msg.includes("O NHIEM")) {
                box.className = "danger-mode"; // Ch·ªõp ƒë·ªè
            } else if (msg.includes("An toan") || msg.includes("khoi dong")) {
                box.className = "safe-mode";   // Xanh l√°
            } else {
                box.className = "";
                box.style.backgroundColor = "#95a5a6"; // X√°m m·∫∑c ƒë·ªãnh
            }
        }
    </script>
</body>
</html>
