<script>
        // 1. C·∫•u h√¨nh k·∫øt n·ªëi HiveMQ Cloud
        // QUAN TR·ªåNG: 
        // - Giao th·ª©c l√† wss:// (Secure WebSocket)
        // - C·ªïng l√† 8884 (Kh√¥ng ph·∫£i 8883 c·ªßa ESP32)
        const host = 'e35ff2a8c16f4c60981704de63982340.s1.eu.hivemq.cloud';
        const port = 8884;
        const clientId = 'WebClient_' + Math.random().toString(16).substr(2, 8);

        const options = {
            keepalive: 60,
            clientId: clientId,
            protocolId: 'MQTT',
            protocolVersion: 4,
            clean: true,
            reconnectPeriod: 1000,
            connectTimeout: 30 * 1000,
            // --- B·∫ÆT BU·ªòC PH·∫¢I C√ì USER/PASS ---
            username: 'Huflit',
            password: 'Huflit123456', // <--- NH·∫¨P M·∫¨T KH·∫®U TH·∫¨T V√ÄO ƒê√ÇY
            // ----------------------------------
            rejectUnauthorized: false
        };

        // ƒê·ªãa ch·ªâ k·∫øt n·ªëi ƒë·∫ßy ƒë·ªß
        const connectUrl = `wss://${host}:${port}/mqtt`;

        const topics = {
            alert: 'simon_house/air/alert',
            temp:  'simon_house/air/temp',
            hum:   'simon_house/air/hum',
            aqi:   'simon_house/air/aqi',
            eco2:  'simon_house/air/eco2',
            tvoc:  'simon_house/air/tvoc'
        };

        console.log('ƒêang k·∫øt n·ªëi t·ªõi:', connectUrl);
        const client = mqtt.connect(connectUrl, options);

        client.on('connect', () => {
            console.log('‚úÖ ƒê√£ k·∫øt n·ªëi t·ªõi HiveMQ!');
            const statusDiv = document.getElementById('status');
            statusDiv.innerText = 'üü¢ ƒê√£ k·∫øt n·ªëi t·ªõi Server HiveMQ';
            statusDiv.style.color = 'green';

            // Subscribe t·∫•t c·∫£ topic
            client.subscribe('simon_house/air/#', (err) => {
                if (!err) console.log('ƒê√£ ƒëƒÉng k√Ω nh·∫≠n tin');
            });
        });

        client.on('error', (err) => {
            console.error('L·ªói k·∫øt n·ªëi:', err);
            client.end();
        });

        client.on('message', (topic, message) => {
            const msg = message.toString();
            console.log(`Nh·∫≠n tin [${topic}]: ${msg}`);

            switch(topic) {
                case topics.temp:
                    document.getElementById('temp').innerText = msg;
                    break;
                case topics.hum:
                    document.getElementById('hum').innerText = msg;
                    break;
                case topics.aqi:
                    document.getElementById('aqi').innerText = msg;
                    // ƒê·ªïi m√†u ch·ªØ AQI d·ª±a tr√™n m·ª©c ƒë·ªô
                    const aqiVal = parseInt(msg);
                    const aqiEl = document.getElementById('aqi');
                    if(aqiVal >= 3) aqiEl.style.color = 'red';
                    else aqiEl.style.color = '#2c3e50';
                    break;
                case topics.eco2:
                    document.getElementById('eco2').innerText = msg;
                    break;
                case topics.tvoc:
                    document.getElementById('tvoc').innerText = msg;
                    break;
                case topics.alert:
                    handleAlert(msg);
                    break;
            }
        });

        function handleAlert(msg) {
            const box = document.getElementById('alert-box');
            box.innerText = msg;

            // Logic ƒë·ªïi m√†u h·ªôp c·∫£nh b√°o
            if (msg.includes("CANH BAO") || msg.includes("O NHIEM")) {
                box.classList.add('danger-mode');
                box.style.backgroundColor = '#e74c3c';
            } else {
                box.classList.remove('danger-mode');
                box.style.backgroundColor = '#2ecc71';
            }
        }
    </script>
